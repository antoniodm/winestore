## Tomcat
cd /home/anto/Scaricati/apache-tomcat-11.0.9/bin
./startup.sh 

## Intellij
/home/anto/Scaricati/idea-IU-251.26927.53

CREATE USER 'admin'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON * . * TO 'admin'@'localhost';




use winestore;

drop table users;
drop table products;
drop table carts;
drop table cart_items;

CREATE TABLE users (
  id            BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  username      VARCHAR(50)  NOT NULL UNIQUE,
  email         VARCHAR(255) NOT NULL UNIQUE,
  password_hash VARCHAR(60)  NOT NULL,
  name          VARCHAR(100) NOT NULL,
  surname       VARCHAR(100) NOT NULL,
  created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE products (
  id              INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  name            VARCHAR(50)  NOT NULL UNIQUE,
  description     VARCHAR(255) NOT NULL,
  origin          VARCHAR(50)  NOT NULL,
  manufacturer    VARCHAR(50)  NOT NULL,
  price_cents     INT UNSIGNED NOT NULL,
  stock           INT UNSIGNED NOT NULL,
  created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE carts (
  id         INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id    BIGINT UNSIGNED NOT NULL,
  status     ENUM('OPEN','CLOSED') NOT NULL DEFAULT 'OPEN',
  is_open    TINYINT(1) AS (status = 'OPEN') STORED,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_cart_user
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY uq_user_open (user_id, is_open)
);

CREATE TABLE cart_items (
  cart_id           INT UNSIGNED NOT NULL,
  product_id        INT UNSIGNED NOT NULL,
  quantity          INT UNSIGNED NOT NULL,
  unit_price_cents  INT UNSIGNED NOT NULL,
  added_at          TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (cart_id, product_id),
  CONSTRAINT fk_ci_cart    FOREIGN KEY (cart_id)    REFERENCES carts(id)    ON DELETE CASCADE,
  CONSTRAINT fk_ci_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT,
  CONSTRAINT ck_qty_positive CHECK (quantity > 0)
);

select * from users;






##### QUERY UTILI ######
Aggiungi al carrello (utente loggato):
INSERT INTO cart_items (cart_id, product_id, quantity, unit_price_cents)
VALUES (?, ?, ?, ?)
ON DUPLICATE KEY UPDATE quantity = quantity + VALUES(quantity);


Recupera (o crea) carrello OPEN dell’utente:
-- prova a trovarlo
SELECT id FROM carts WHERE user_id = ? AND status='OPEN';
-- se non c'è, crealo
INSERT INTO carts (user_id) VALUES (?);
SELECT LAST_INSERT_ID() AS cart_id;




###### DATA DEMO #####

-- Assumo schema già creato come da tue tabelle
USE winestore;

-- PULIZIA (mantiene integrità FK)
SET FOREIGN_KEY_CHECKS=0;
TRUNCATE TABLE cart_items;
TRUNCATE TABLE carts;
TRUNCATE TABLE products;
TRUNCATE TABLE users;
SET FOREIGN_KEY_CHECKS=1;

-- ===== USERS =====
-- password_hash = bcrypt di "password" (solo demo)
INSERT INTO users (username, email, password_hash, name, surname) VALUES
('antonio', 'antonio@example.com', '$2a$10$7EqJtq98hPqEX7fNZaFWoOhi5CrQZ8lS9G4AOb.zG/qi8s8.cjFHe', 'Antonio', 'Rossi'),
('maria',   'maria@example.com',   '$2a$10$7EqJtq98hPqEX7fNZaFWoOhi5CrQZ8lS9G4AOb.zG/qi8s8.cjFHe', 'Maria',   'Bianchi'),
('luca',    'luca@example.com',    '$2a$10$7EqJtq98hPqEX7fNZaFWoOhi5CrQZ8lS9G4AOb.zG/qi8s8.cjFHe', 'Luca',    'Verdi');

-- IDs: 1=antonio, 2=maria, 3=luca

-- ===== PRODUCTS =====
INSERT INTO products (name, description, origin, manufacturer, price_cents, stock) VALUES
('Barolo DOCG 2018', 'Rosso strutturato, affinamento in botte.', 'Piemonte',  'Cantina Alba',            2599, 30),
('Brunello di Montalcino 2017', 'Elegante, note di ciliegia e spezie.', 'Toscana',   'Fattoria Val d\'Orcia', 3499, 18),
('Chianti Classico 2020', 'Fresco e versatile, ottimo a tavola.', 'Toscana',   'Podere del Sasso',       1499, 50),
('Amarone della Valpolicella 2016', 'Corposo, uve appassite.', 'Veneto',    'Cantina della Valpolicella', 3999, 12),
('Prosecco DOC Extra Dry', 'Spumante fragrante e fruttato.', 'Veneto',    'Casa Frizzante',            899,  100),
('Montepulciano d\'Abruzzo 2019', 'Fruttato, tannino morbido.', 'Abruzzo',   'Terre d\'Abruzzo',         1199, 40),
('Nero d\'Avola 2021', 'Caldo e speziato.', 'Sicilia',    'Cantine Siciliane',         1099, 45),
('Etna Rosso 2020', 'Minerale, da suoli vulcanici.', 'Sicilia',    'Vigne Etnee',               2199, 20),
('Franciacorta Brut', 'Metodo classico, fine perlage.', 'Lombardia', 'Tenuta Franciacorta',      2899, 15),
('Verdicchio dei Castelli di Jesi 2021', 'Bianco sapido, note floreali.', 'Marche',    'Colline Marchigiane',      999,  35),
('Barbera d\'Asti 2020', 'Vivace, ottima bevibilità.', 'Piemonte',  'Colline Astigiane',         1399, 30),
('Lugana DOC 2021', 'Bianco elegante del Garda.', 'Lombardia', 'Lago Winery',               1699, 25);

-- IDs prodotti: 1..12 nell’ordine sopra

-- ===== CARTS =====
-- Un carrello OPEN per ogni utente + uno ORDERED di storico + uno anonimo OPEN
INSERT INTO carts (user_id) VALUES (1), (2), (3);                -- id 1..3, OPEN
INSERT INTO carts (user_id, status) VALUES (1,'ORDERED'), (3,'ORDERED'); -- id 4..5, chiusi
INSERT INTO carts (session_token) VALUES ('9b30e7d6-5f10-4a2a-9f4f-2d3f2b567c9a'); -- id 6, OPEN anonimo

-- ===== CART_ITEMS =====
-- Carrello OPEN di Antonio (id=1)
INSERT INTO cart_items (cart_id, product_id, quantity, unit_price_cents) VALUES
(1, 1,  2, 2599),   -- 2x Barolo
(1, 3,  1, 1499),   -- 1x Chianti
(1, 9,  1, 2899);   -- 1x Franciacorta

-- Carrello OPEN di Maria (id=2)
INSERT INTO cart_items (cart_id, product_id, quantity, unit_price_cents) VALUES
(2, 7,  2, 1099),   -- 2x Nero d'Avola
(2, 10, 2,  999);   -- 2x Verdicchio

-- Carrello OPEN di Luca (id=3)
INSERT INTO cart_items (cart_id, product_id, quantity, unit_price_cents) VALUES
(3, 4,  1, 3999);   -- 1x Amarone

-- Carrello ORDERED di Antonio (id=4)
INSERT INTO cart_items (cart_id, product_id, quantity, unit_price_cents) VALUES
(4, 2,  1, 3499),   -- 1x Brunello
(4, 5,  3,  899);   -- 3x Prosecco

-- Carrello ORDERED di Luca (id=5)
INSERT INTO cart_items (cart_id, product_id, quantity, unit_price_cents) VALUES
(5, 11, 6, 1399);   -- 6x Barbera

-- Carrello OPEN Anonimo (id=6)
INSERT INTO cart_items (cart_id, product_id, quantity, unit_price_cents) VALUES
(6, 6,  1, 1199),   -- 1x Montepulciano
(6, 5,  2,  899);   -- 2x Prosecco
