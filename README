CREATE USER 'admin'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON * . * TO 'admin'@'localhost';

use winestore;

SET FOREIGN_KEY_CHECKS=0;
DROP TABLE IF EXISTS cart_items;
DROP TABLE IF EXISTS carts;
DROP TABLE IF EXISTS products;
DROP TABLE IF EXISTS users;
SET FOREIGN_KEY_CHECKS=1;

CREATE TABLE users (
  id            BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  username      VARCHAR(50)  NOT NULL UNIQUE,
  email         VARCHAR(255) NOT NULL UNIQUE,
  password_hash VARCHAR(60)  NOT NULL,
  name          VARCHAR(100) NOT NULL,
  surname       VARCHAR(100) NOT NULL,
  address       VARCHAR(255) NOT NULL,
  birth_date    DATE NOT NULL,
  money         INT UNSIGNED NOT NULL,

  created_at    TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE products (
  id              INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  name            VARCHAR(50)  NOT NULL UNIQUE,
  description     VARCHAR(255) NOT NULL,
  origin          VARCHAR(50)  NOT NULL,
  manufacturer    VARCHAR(50)  NOT NULL,
  price_cents     INT UNSIGNED NOT NULL,
  stock           INT UNSIGNED NOT NULL,
  created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE carts (
  id            INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id       BIGINT UNSIGNED NULL,
  session_token CHAR(36) NULL,
  is_open       BOOLEAN NOT NULL DEFAULT TRUE,
  created_at    TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- vincoli di unicità condizionati (MySQL 8.0+)
CREATE UNIQUE INDEX uq_open_user ON carts ( (CASE WHEN is_open THEN user_id END) );

CREATE UNIQUE INDEX uq_open_sess ON carts ( (CASE WHEN is_open THEN session_token END) );

CREATE TABLE cart_items (
  cart_id           INT UNSIGNED NOT NULL,
  product_id        INT UNSIGNED NOT NULL,
  quantity          INT UNSIGNED NOT NULL,
  unit_price_cents  INT UNSIGNED NOT NULL,
  added_at          TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (cart_id, product_id),
  FOREIGN KEY (cart_id)    REFERENCES carts(id)    ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT
);

-- ===== PRODUCTS =====
INSERT INTO products (name, description, origin, manufacturer, price_cents, stock) VALUES
-- Piemonte
('Barolo DOCG 2018',
 'Nebbiolo strutturato con note di rosa, liquirizia e catrame; tannino saldo e finale lungo.',
 'Piemonte, Barolo DOCG',
 'Tenuta Colline Nebbio',
 3999, 24),

('Barbaresco DOCG 2019',
 'Elegante interpretazione di Nebbiolo: viola, piccoli frutti rossi, spezie dolci; tannini setosi.',
 'Piemonte, Barbaresco DOCG',
 'Cantina del Rabajà',
 3699, 28),

('Gavi 2021',
 'Cortese fresco e minerale, agrumi e fiori bianchi; ottimo su pesce e crostacei.',
 'Piemonte, Gavi DOCG',
 'Vigneti della Rovere',
 1499, 60),

-- Toscana
('Chianti Classico 2020',
 'Sangiovese succoso: ciliegia croccante, viola e lieve nota balsamica; beva agile.',
 'Toscana, Chianti Classico DOCG',
 'Podere Poggio al Vento',
 1499, 75),

('Brunello di Montalcino 2017',
 'Sangiovese di grande profondità: amarena, tabacco, spezie; finale lunghissimo.',
 'Toscana, Brunello di Montalcino DOCG',
 'Azienda Agricola La Torre',
 4499, 18),

('Bolgheri Rosso 2020',
 'Taglio bordolese mediterraneo: ribes nero, erbe aromatiche, trama setosa.',
 'Toscana, Bolgheri Rosso DOC',
 'Tenuta Marina Alta',
 2599, 40),

-- Veneto
('Amarone della Valpolicella 2016',
 'Uvaggio appassito: prugna, cioccolato amaro e spezie; caldo e avvolgente.',
 'Veneto, Amarone della Valpolicella DOCG',
 'Cantine del Pietrone',
 4999, 15),

('Valpolicella Ripasso 2020',
 'Frutto maturo e speziatura dolce, corpo medio e tannino morbido.',
 'Veneto, Valpolicella Ripasso DOC',
 'Casa Vinicola Pianalto',
 1899, 52),

('Soave Classico 2021',
 'Garganega agrumata e sapida, mandorla finale; grande versatilità a tavola.',
 'Veneto, Soave Classico DOC',
 'Vigneti Monte Bianco',
 999, 80),

('Prosecco Superiore Brut NV',
 'Bollicina fine, mela verde e pera; sorso snello e rinfrescante.',
 'Veneto, Prosecco Superiore DOCG',
 'Colline di Valdobbiadene',
 1299, 120),

-- Lombardia
('Franciacorta Brut NV',
 'Spumante metodo classico: crosta di pane, mela gialla, bollicina cremosa.',
 'Lombardia, Franciacorta DOCG',
 'Franciacorta Settevalli',
 2999, 36),

-- Trentino-Alto Adige / Friuli
('Pinot Grigio 2022',
 'Bianco secco e fragrante: pera, mela e lieve nota floreale.',
 'Friuli, Pinot Grigio DOC',
 'Cantine delle Grave',
 899, 95),

('Gewurztraminer 2021',
 'Aromaticità intensa: litchi, rosa e spezie; morbido ma equilibrato.',
 'Trentino-Alto Adige, Gewurztraminer DOC',
 'Cantina Altofresco',
 1699, 34),

('Lagrein 2020',
 'Rosso alpino dal frutto scuro, speziato e con tannino vellutato.',
 'Trentino-Alto Adige, Lagrein DOC',
 'Vignaioli di Bolzano',
 1799, 32),

-- Sicilia & Sud
('Nero d''Avola 2021',
 'Frutto caldo di amarena e prugna, balsamico; piacevole struttura.',
 'Sicilia, Nero d''Avola DOC',
 'Tenuta Scirocco',
 1299, 70),

('Etna Rosso 2019',
 'Nerello elegante: ribes, cenere vulcanica, tannini fini e freschezza.',
 'Sicilia, Etna Rosso DOC',
 'Tenuta Etnea',
 1999, 38),

('Grillo 2022',
 'Agrumi e fiori bianchi, sorso sapido e allungo salino.',
 'Sicilia, Grillo DOC',
 'Cantina del Sole',
 1099, 85),

('Primitivo di Manduria 2020',
 'Mirtillo, confettura e spezie dolci; morbidezza e calore al palato.',
 'Puglia, Primitivo di Manduria DOC',
 'Masseria del Salento',
 1699, 58),

-- Sardegna
('Vermentino di Gallura 2021',
 'Aromi mediterranei, agrumi e erbe; scia minerale persistente.',
 'Sardegna, Vermentino di Gallura DOCG',
 'Cantina Arcipelago',
 1699, 44),

('Cannonau di Sardegna 2020',
 'Frutto rosso maturo, macchia mediterranea; tannino morbido.',
 'Sardegna, Cannonau di Sardegna DOC',
 'Vigne del Maestrale',
 1399, 50),

-- Centro & Adriatico
('Montepulciano d''Abruzzo 2021',
 'More, pepe nero e liquirizia; struttura media e beva quotidiana.',
 'Abruzzo, Montepulciano d''Abruzzo DOC',
 'Colline Adriatiche',
 1199, 88),

('Verdicchio dei Castelli di Jesi 2021',
 'Note di fiori bianchi, mandorla e agrumi; finale sapido.',
 'Marche, Verdicchio dei Castelli di Jesi DOC',
 'Cantina del Metauro',
 1099, 62),

-- Campania & Emilia
('Greco di Tufo 2021',
 'Agrumi maturi e pietra focaia; bocca tesa e minerale.',
 'Campania, Greco di Tufo DOCG',
 'Azienda Agricola Irpina',
 1799, 40),

('Fiano di Avellino 2021',
 'Fiori gialli, nocciola e miele; struttura e profondità.',
 'Campania, Fiano di Avellino DOCG',
 'Tenute del Partenio',
 1899, 35),

('Lambrusco di Sorbara 2022',
 'Rosso frizzante secco: fragolina, viola e grande freschezza.',
 'Emilia-Romagna, Lambrusco di Sorbara DOC',
 'Cantina del Sorbara',
 799, 110),

-- Umbria
('Sagrantino di Montefalco 2016',
 'Potente e tannico: mora, cacao e spezia; lungo potenziale evolutivo.',
 'Umbria, Sagrantino di Montefalco DOCG',
 'Tenuta Colle Umbro',
 3299, 20);
